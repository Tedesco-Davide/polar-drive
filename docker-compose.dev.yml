# docker-compose.dev.yml
# Configurazione SVILUPPO con SQL Server locale

services:

  initdb:
    container_name: polardrive-initdb-dev
    image: polardrive-initdb:latest
    environment:
      - DOTNET_ENVIRONMENT=Development
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=${CONNECTION_STRING}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - polardrive-network-dev
    profiles:
      - tools

  mock-api:
    container_name: polardrive-mock-api-dev
    image: polardrive-mock:latest 
    environment:
      - DOTNET_ENVIRONMENT=Development
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=${CONNECTION_STRING}
      - WebAPI__BaseUrl=http://api:8080
    ports:
      - "9090:9090"
    networks:
      - polardrive-network-dev
    restart: always

  api:
    container_name: polardrive-api-dev
    image: polardrive-api:latest
    user: "0:0" 
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - POLAR_LOG_DIR=/app/Logs
      - ConnectionStrings__DefaultConnection=${CONNECTION_STRING}
      - WebAPI__BaseUrl=http://api:8080
      - PublicBaseUrl=${PUBLIC_BASE_URL}
      - TeslaApi__BaseUrl=${TESLA_API_BASE_URL}
      - TeslaApi__PublicBaseUrl=${TESLA_API_PUBLIC_BASE_URL}
      - TeslaApi__ClientId=${TESLA_CLIENT_ID}
      - TeslaApi__ClientSecret=${TESLA_CLIENT_SECRET}
      - Jwt__SecretKey=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Jwt__ExpirationMinutes=${JWT_EXPIRATION_MINUTES}
      - Vonage__AccountSid=${Vonage__AccountSid}
      - Vonage__AuthToken=${Vonage__AuthToken}
      - Vonage__PhoneNumber=${Vonage__PhoneNumber}
      - Vonage__WebhookUrl=${Vonage__WebhookUrl}
      - Vonage__EnableSignatureValidation=${Vonage__EnableSignatureValidation}
      - Vonage__RateLimitPerMinute=${Vonage__RateLimitPerMinute}
      - Ollama__Endpoint=${OLLAMA_ENDPOINT}
      - Ollama__Model=${OLLAMA_MODEL}
      - Ollama__Temperature=${OLLAMA_TEMPERATURE}
      - Ollama__TopP=${OLLAMA_TOP_P}
      - Ollama__ContextWindow=${OLLAMA_CONTEXT_WINDOW}
      - Ollama__MaxTokens=${OLLAMA_MAX_TOKENS}
      - Ollama__RepeatPenalty=${OLLAMA_REPEAT_PENALTY}
      - Ollama__TopK=${OLLAMA_TOP_K}
      - Ollama__MaxRetries=${OLLAMA_MAX_RETRIES}
      - Ollama__RetryDelaySeconds=${OLLAMA_RETRY_DELAY_SECONDS}
      - TSA_SERVER_URL=${TSA_SERVER_URL}
      - TSA_ARUBA_USERNAME=${TSA_ARUBA_USERNAME}
      - TSA_ARUBA_PASSWORD=${TSA_ARUBA_PASSWORD}
      - TSA_ARUBA_POLICY_OID=${TSA_ARUBA_POLICY_OID}
    volumes:
      - ./LOGS_DEV:/app/Logs
      - ./vehicle-options.json:/app/config/vehicle-options.json:ro
      - ./app-config.json:/app/config/app-config.json:ro
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - polardrive-network-dev
    restart: always

  frontend:
    container_name: polardrive-frontend-dev
    image: polardrive-frontend:latest
    environment:
      - TZ=Europe/Rome
      - NODE_ENV=production
      - API_BACKEND_URL=http://host.docker.internal:8080
    volumes:
      - ./app-config.json:/app/config/app-config.json:ro
    ports:
      - "3000:3000"
    networks:
      - polardrive-network-dev
    restart: always

networks:
  polardrive-network-dev:
    external: true