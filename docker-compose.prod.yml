# docker-compose.prod.yml
# Configurazione PRODUZIONE con SQL Server locale

services:
  api:
    container_name: polardrive-api-prod
    image: polardrive-api:latest
    user: "0:0" 
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - POLAR_LOG_DIR=/app/Logs
      - ConnectionStrings__DefaultConnection=${CONNECTION_STRING}
      - WebAPI__BaseUrl=http://api:8081
      - PublicBaseUrl=${PUBLIC_BASE_URL}
      - TeslaApi__BaseUrl=${TESLA_API_BASE_URL}
      - TeslaApi__PublicBaseUrl=${TESLA_API_PUBLIC_BASE_URL}
      - TeslaApi__ClientId=${TESLA_CLIENT_ID}
      - TeslaApi__ClientSecret=${TESLA_CLIENT_SECRET}
      - Jwt__SecretKey=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Jwt__ExpirationMinutes=${JWT_EXPIRATION_MINUTES}
      - Vonage__AccountSid=${Vonage__AccountSid}
      - Vonage__AuthToken=${Vonage__AuthToken}
      - Vonage__PhoneNumber=${Vonage__PhoneNumber}
      - Vonage__WebhookUrl=${Vonage__WebhookUrl}
      - Vonage__EnableSignatureValidation=${Vonage__EnableSignatureValidation}
      - Vonage__RateLimitPerMinute=${Vonage__RateLimitPerMinute}
      - Vonage__AllowedPhoneNumbers__0=${Vonage__AllowedPhoneNumbers__0}
      - Ollama__Endpoint=${OLLAMA_ENDPOINT}
      - Ollama__Model=${OLLAMA_MODEL}
      - Ollama__Temperature=${OLLAMA_TEMPERATURE}
      - Ollama__TopP=${OLLAMA_TOP_P}
      - Ollama__ContextWindow=${OLLAMA_CONTEXT_WINDOW}
      - Ollama__MaxTokens=${OLLAMA_MAX_TOKENS}
      - Ollama__RepeatPenalty=${OLLAMA_REPEAT_PENALTY}
      - Ollama__TopK=${OLLAMA_TOP_K}
      - Ollama__MaxRetries=${OLLAMA_MAX_RETRIES}
      - Ollama__RetryDelaySeconds=${OLLAMA_RETRY_DELAY_SECONDS}
    volumes:
      - ./LOGS_PROD:/app/Logs
      - ./vehicle-options.json:/app/config/vehicle-options.json:ro
    ports:
      - "8081:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - polardrive-network-prod
    restart: always

  mock-api:
    profiles:
      - donotstart

  frontend:
    container_name: polardrive-frontend-prod
    image: polardrive-frontend:latest
    environment:
      - TZ=Europe/Rome
      - NODE_ENV=production
      - API_BACKEND_URL=http://host.docker.internal:8081
    ports:
      - "3001:3000"
    networks:
      - polardrive-network-prod
    restart: always

networks:
  polardrive-network-prod:
    external: true